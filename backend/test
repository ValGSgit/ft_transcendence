#!/bin/bash

# Comprehensive Backend Test Script
# Tests all major functionality of the Transcendence backend

echo "ðŸ§ª TRANSCENDENCE BACKEND TEST SUITE"
echo "===================================="
echo ""

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Start server in background
echo "Starting server..."
npm start > /tmp/transcendence-test.log 2>&1 &
SERVER_PID=$!
sleep 3

# Function to cleanup on exit
cleanup() {
    echo ""
    echo "Cleaning up..."
    kill $SERVER_PID 2>/dev/null
    wait $SERVER_PID 2>/dev/null
    echo "Server stopped"
}
trap cleanup EXIT

# Test counter
TESTS_PASSED=0
TESTS_FAILED=0

# Test function
test_endpoint() {
    local name="$1"
    local result="$2"
    local pattern="${3:-\"success\":true}"
    
    if echo "$result" | grep -q "$pattern"; then
        echo -e "${GREEN}âœ“${NC} $name"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}âœ—${NC} $name"
        echo "   Response: $result"
        ((TESTS_FAILED++))
    fi
}

echo -e "${YELLOW}Testing Health & Info Endpoints${NC}"
echo "--------------------------------"

# Test health endpoint
HEALTH=$(curl -s http://localhost:3000/api/health)
test_endpoint "Health check" "$HEALTH" '"status":"ok"'

echo ""
echo -e "${YELLOW}Testing Authentication${NC}"
echo "----------------------"

# Test registration
REGISTER=$(curl -s -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "alice",
    "email": "alice@example.com",
    "password": "SecurePass123"
  }')
test_endpoint "User registration" "$REGISTER"

# Extract token
TOKEN1=$(echo "$REGISTER" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['token'])" 2>/dev/null)

# Test login
LOGIN=$(curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "alice@example.com",
    "password": "SecurePass123"
  }')
test_endpoint "User login" "$LOGIN"

# Test get me
ME=$(curl -s http://localhost:3000/api/auth/me \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Get current user profile" "$ME"

echo ""
echo -e "${YELLOW}Testing User Management${NC}"
echo "-----------------------"

# Register second user
REGISTER2=$(curl -s -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "bob",
    "email": "bob@example.com",
    "password": "SecurePass456"
  }')
test_endpoint "Second user registration" "$REGISTER2"

TOKEN2=$(echo "$REGISTER2" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['token'])" 2>/dev/null)

# Test get all users
USERS=$(curl -s http://localhost:3000/api/users \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Get all users" "$USERS"

# Test search users
SEARCH=$(curl -s "http://localhost:3000/api/users/search?q=alice" \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Search users" "$SEARCH"

# Test update profile
UPDATE=$(curl -s -X PUT http://localhost:3000/api/users/profile \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{
    "bio": "I love playing Pong!",
    "status": "Ready to play!"
  }')
test_endpoint "Update profile" "$UPDATE"

echo ""
echo -e "${YELLOW}Testing Friend System${NC}"
echo "---------------------"

# Send friend request
FRIEND_REQ=$(curl -s -X POST http://localhost:3000/api/friends/requests \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"receiverId": 2}')
test_endpoint "Send friend request" "$FRIEND_REQ"

# Get pending requests (as bob)
PENDING=$(curl -s http://localhost:3000/api/friends/requests/pending \
  -H "Authorization: Bearer $TOKEN2")
test_endpoint "Get pending friend requests" "$PENDING"

# Accept friend request
ACCEPT=$(curl -s -X POST http://localhost:3000/api/friends/requests/1/accept \
  -H "Authorization: Bearer $TOKEN2")
test_endpoint "Accept friend request" "$ACCEPT"

# Get friends list
FRIENDS=$(curl -s http://localhost:3000/api/friends \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Get friends list" "$FRIENDS"

echo ""
echo -e "${YELLOW}Testing Chat System${NC}"
echo "-------------------"

# Create direct chat room
DIRECT=$(curl -s http://localhost:3000/api/chat/direct/2 \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Create direct message room" "$DIRECT"

ROOM_ID=$(echo "$DIRECT" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['room']['id'])" 2>/dev/null)

# Send message
MESSAGE=$(curl -s -X POST http://localhost:3000/api/chat/rooms/$ROOM_ID/messages \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"content": "Hey Bob! Want to play Pong?"}')
test_endpoint "Send chat message" "$MESSAGE"

# Get messages
MESSAGES=$(curl -s http://localhost:3000/api/chat/rooms/$ROOM_ID/messages \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Get chat messages" "$MESSAGES"

echo ""
echo -e "${YELLOW}Testing Game System${NC}"
echo "-------------------"

# Get game config
CONFIG=$(curl -s http://localhost:3000/api/game/config)
test_endpoint "Get game configuration" "$CONFIG"

# Create AI game (easy)
AI_GAME_EASY=$(curl -s -X POST http://localhost:3000/api/game \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"isAI": true, "aiDifficulty": "easy"}')
test_endpoint "Create AI game (easy)" "$AI_GAME_EASY"

# Create AI game (medium)
AI_GAME_MED=$(curl -s -X POST http://localhost:3000/api/game \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"isAI": true, "aiDifficulty": "medium"}')
test_endpoint "Create AI game (medium)" "$AI_GAME_MED"

# Create AI game (hard)
AI_GAME_HARD=$(curl -s -X POST http://localhost:3000/api/game \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"isAI": true, "aiDifficulty": "hard"}')
test_endpoint "Create AI game (hard)" "$AI_GAME_HARD"

GAME_ID=$(echo "$AI_GAME_MED" | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['game']['id'])" 2>/dev/null)

# Start game
START=$(curl -s -X POST http://localhost:3000/api/game/$GAME_ID/start \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Start game" "$START"

# Update score
SCORE=$(curl -s -X POST http://localhost:3000/api/game/$GAME_ID/score \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"player1Score": 11, "player2Score": 7}')
test_endpoint "Update game score" "$SCORE"

# End game
END=$(curl -s -X POST http://localhost:3000/api/game/$GAME_ID/end \
  -H "Authorization: Bearer $TOKEN1" \
  -H "Content-Type: application/json" \
  -d '{"winnerId": 1}')
test_endpoint "End game" "$END"

# Get match history
HISTORY=$(curl -s http://localhost:3000/api/game/history \
  -H "Authorization: Bearer $TOKEN1")
test_endpoint "Get match history" "$HISTORY"

# Get leaderboard
LEADERBOARD=$(curl -s http://localhost:3000/api/game/leaderboard)
test_endpoint "Get leaderboard" "$LEADERBOARD"

echo ""
echo -e "${YELLOW}Testing Notifications${NC}"
echo "----------------------"

# Get notifications
NOTIFS=$(curl -s http://localhost:3000/api/notifications \
  -H "Authorization: Bearer $TOKEN2")
test_endpoint "Get notifications" "$NOTIFS"

echo ""
echo "===================================="
echo -e "${GREEN}Tests Passed: $TESTS_PASSED${NC}"
if [ $TESTS_FAILED -gt 0 ]; then
    echo -e "${RED}Tests Failed: $TESTS_FAILED${NC}"
else
    echo -e "${GREEN}Tests Failed: $TESTS_FAILED${NC}"
fi
echo "===================================="

if [ $TESTS_FAILED -eq 0 ]; then
    echo -e "${GREEN}âœ“ All tests passed!${NC}"
    exit 0
else
    echo -e "${RED}âœ— Some tests failed${NC}"
    exit 1
fi
